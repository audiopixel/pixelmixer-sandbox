<!DOCTYPE html>
<html lang="en">
	<head>
		<title>GLSL Sandbox</title>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
		<style>

			body {

				background-color: #000000;
				margin: 0;
				padding: 0;
				overflow: hidden;

			}

			button, select, a, a:visited {

				padding: 8px 12px 8px 12px;

				border: none;
				border-radius: 5px;
				margin-right: 5px;

				color: #ffffff;
				background-color: #000000;
				opacity: 0.5;

				font-family: Monospace;
				font-size: 12px;
				font-weight: bold;

				cursor: pointer;
				text-decoration: none;

			}

			button:hover, select:hover, a:hover {

				opacity: 1;
				box-shadow: 0 0 4px #FFF;

			}

			option {

				color: #ffffff;
				background-color: #000000;

			}

		</style>
	</head>
	<body>

		<link rel="stylesheet" href="css/codemirror.css">
		<link rel="stylesheet" href="css/default.css">

		<script src="js/lzma.js"></script>
		<script src='js/jquery.js'></script>
		<script src='js/helpers.js'></script>
		<script src="js/codemirror.js"></script>
		<script src="js/glsl.js"></script>


		<script>

			initialize_helper();

			var compressor=initialize_compressor();

			if ( !window.requestAnimationFrame ) {

				window.requestAnimationFrame = ( function() {

					return window.webkitRequestAnimationFrame ||
						window.mozRequestAnimationFrame ||
						window.oRequestAnimationFrame ||
						window.msRequestAnimationFrame ||
						function ( callback, element ) {

							window.setTimeout( callback, 1000 / 60 );

						};

				} )();

			}


			var toolbar, compileButton, compileTimer, errorLines = [];
			var parameters = { startTime: Date.now(), time: 0, mouseX: 0.5, mouseY: 0.5, screenWidth: 0, screenHeight: 0 },
			surface = { centerX: 0, centerY: 0, width: 1, height: 1, isPanning: false, isZooming: false, lastX: 0, lastY: 0 },
			code, resizer = {}, compileOnChangeCode = true;

			init();

			function init() {

				toolbar = document.createElement( 'div' );
				toolbar.style.position = 'absolute';
				toolbar.style.top = '25px';
				toolbar.style.left = '25px';
				document.body.appendChild( toolbar );

				var rightside = document.createElement( 'div' );
				rightside.style.cssFloat = 'right';
				toolbar.appendChild( rightside );

				var button = document.createElement( 'button' );
				button.textContent = 'hide code';
				button.addEventListener( 'click', function ( event ) {

					if ( isCodeVisible() ) {

						button.textContent = 'show code';
						code.getWrapperElement().style.display = 'none';
						compileButton.style.visibility = 'hidden';
						set_save_button('hidden');
						set_parent_button('hidden');
						stopHideUI();

					} else {

						button.textContent = 'hide code';
						code.getWrapperElement().style.display = '';
						compileButton.style.visibility = 'visible';
						set_save_button('visible');
						set_parent_button('visible');

					}

				}, false );
				toolbar.appendChild( button );


				compileButton = document.createElement( 'button' );
				compileButton.textContent = 'compile';
				compileButton.addEventListener( 'click', function ( event ) {

					compile();

				}, false );
				toolbar.appendChild( compileButton );

				// from helper.js
				add_server_buttons();

				// Initialise WebGL


				// initialize code editor
				code = CodeMirror(document.body, {
					lineNumbers: true,
					matchBrackets: true,
					indentWithTabs: true,
					tabSize: 8,
					indentUnit: 8,
					mode: "text/x-glsl",
					onChange: function () {
						if (compileOnChangeCode) {
							clearTimeout(compileTimer);
							compileTimer = setTimeout(codeChange, 500);
						}
					}
				});
				code.getWrapperElement().style.display = '';

				resizer.offsetMouseX = 0;
				resizer.offsetMouseY = 0;
				resizer.isResizing = false;
				resizer.currentWidth = 100;
				resizer.currentHeight = 100;
				resizer.minWidth = 100;
				resizer.minHeight = 100;
				resizer.maxWidth = 100;
				resizer.maxHeight = 100;
				resizer.element = document.createElement( 'div' );
				resizer.element.className = 'resizer';
				code.getWrapperElement().appendChild(resizer.element);

				resizer.element.addEventListener( 'mousedown', function ( event ) {
					if (event.button !== 2) {
						resizer.offsetMouseX = event.clientX - resizer.currentWidth;
						resizer.offsetMouseY = event.clientY - resizer.currentHeight;
						resizer.isResizing = true;
						event.preventDefault();
					}
				}, false );
				
				
				var clientXLast, clientYLast;

				document.addEventListener( 'mousemove', function ( event ) {

					var clientX = event.clientX;
					var clientY = event.clientY;

					if (clientXLast == clientX && clientYLast == clientY)
						return;

					clientXLast = clientX;
					clientYLast = clientY;

					stopHideUI();

					var codeElement, dx, dy;
					
					parameters.mouseX = clientX / window.innerWidth;
					parameters.mouseY = 1 - clientY / window.innerHeight;
						
					if (resizer.isResizing) {

						resizer.currentWidth = Math.max(Math.min(clientX - resizer.offsetMouseX, resizer.maxWidth), resizer.minWidth);
						resizer.currentHeight = Math.max(Math.min(clientY - resizer.offsetMouseY, resizer.maxHeight), resizer.minWidth);
						codeElement = code.getWrapperElement();
						codeElement.style.width = resizer.currentWidth + 'px';
						codeElement.style.height = resizer.currentHeight + 'px';
						code.refresh();
						event.preventDefault();

					} else if (surface.isPanning) {

						dx = clientX - surface.lastX;
						dy = clientY - surface.lastY;
						surface.centerX -= dx * surface.width / window.innerWidth;
						surface.centerY += dy * surface.height / window.innerHeight;
						surface.lastX = clientX;
						surface.lastY = clientY;
						event.preventDefault();

					} else if (surface.isZooming) {

						dx = clientX - surface.lastX;
						dy = clientY - surface.lastY;
						surface.height *= Math.pow(0.997, dx + dy);
						surface.lastX = clientX;
						surface.lastY = clientY;
						event.preventDefault();

					}
				}, false );

				function settleDown ( event ) {
					resizer.isResizing = surface.isPanning = surface.isZooming = false;
					document.body.style.cursor = 'default';
				}

				function mouseLeave(event) {
					settleDown(event);

					if (!isCodeVisible())
						startHideUITimer();
				}

				document.addEventListener( 'mouseup', settleDown, false );
				document.addEventListener( 'mouseleave', mouseLeave, false );

				onWindowResize();
				window.addEventListener( 'resize', onWindowResize, false );

				code.setValue("Test");

			}

			function isCodeVisible() {
				return code && code.getWrapperElement().style.display !== 'none';
			}

			var hideUITimer;
			var isUIHidden = false;

			function startHideUITimer () {

				stopHideUITimer();
				if (!isUIHidden && !isCodeVisible())
					hideUITimer = window.setTimeout(onHideUITimer, 1000 * 5 );

				function onHideUITimer() {

					stopHideUITimer();
					if (!isUIHidden && !isCodeVisible()) {

						isUIHidden = true;
						toolbar.style.display = 'none';
						document.body.style.cursor = 'none';
					}
				}

				function stopHideUITimer () {

					if (hideUITimer) {

						window.clearTimeout(hideUITimer);
						hideUITimer = 0;
					}
				}
			}

			function stopHideUI () {

				if (isUIHidden) {

					isUIHidden = false;
					toolbar.style.display = '';
					document.body.style.cursor = '';
				}
				startHideUITimer();
			}
			//

			function onWindowResize( event ) {

				var isMaxWidth = ((resizer.currentWidth === resizer.maxWidth) || (resizer.currentWidth === resizer.minWidth)),
					isMaxHeight = ((resizer.currentHeight === resizer.maxHeight) || (resizer.currentHeight === resizer.minHeight));

				toolbar.style.width = window.innerWidth - 47 + 'px';

				resizer.isResizing = false;
				resizer.maxWidth = window.innerWidth - 75;
				resizer.maxHeight = window.innerHeight - 125;
				if (isMaxWidth || (resizer.currentWidth > resizer.maxWidth)) {
					resizer.currentWidth = resizer.maxWidth;
				}
				if (isMaxHeight || (resizer.currentHeight > resizer.maxHeight)) {
					resizer.currentHeight = resizer.maxHeight;
				}
				if (resizer.currentWidth < resizer.minWidth) { resizer.currentWidth = resizer.minWidth; }
				if (resizer.currentHeight < resizer.minHeight) { resizer.currentHeight = resizer.minHeight; }

				code.getWrapperElement().style.top = '75px';
				code.getWrapperElement().style.left = '25px';
				code.getWrapperElement().style.width = resizer.currentWidth + 'px';
				code.getWrapperElement().style.height = resizer.currentHeight + 'px';

			}

			//

			function codeChange() {

				if(compileOnChangeCode){

					compile();

				}

			}

			//

			function compile() {

				console.log("compile");

			}

			//

			function animate() {

				requestAnimationFrame( animate );
				render();

			}

			function render() {

				

			}

		</script>

	</body>
</html>
